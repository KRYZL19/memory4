!function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).XMPP=t()}(function(){var t=function(e){var r;return function(t){return r||e(r={exports:{},parent:t},r.exports),r.exports}},e=t(function(t,e){"use strict";var r;r=function(t,e){function r(){}r.prototype.name="PLAIN",r.prototype.clientFirst=!0,r.prototype.response=function(t){var e="";return e+=t.authzid||"",e+="\0",e+=t.username,e+="\0",e+=t.password},r.prototype.challenge=function(t){return this},e.exports=r},"object"==typeof e&&r(0,t)}),r=t(function(t,e){"use strict";var r;r=function(t,e){function r(){}r.prototype.name="ANONYMOUS",r.prototype.clientFirst=!0,r.prototype.response=function(t){return t.trace||""},r.prototype.challenge=function(t){},e.exports=r},"object"==typeof e&&r(0,t)}),n=t(function(t,e){"use strict";var r;r=function(t,e){function r(){this._mechs=[]}r.prototype.use=function(t,e){return e||(t=(e=t).prototype.name),this._mechs.push({name:t,mech:e}),this},r.prototype.create=function(t){for(var e=0,r=this._mechs.length;e<r;e++)for(var n=0,o=t.length;n<o;n++){var i=this._mechs[e];if(i.name==t[n])return new i.mech}return null},e.exports=r},"object"==typeof e&&r(0,t)}),u={};((u=function(t){return t&&t.__esModule?t:{default:t}}).default=u).__esModule=!0;var o={};((o=function(t,e){if(null==t)return{};for(var r,n={},o=Object.keys(t),i=0;i<o.length;i++)r=o[i],0<=e.indexOf(r)||(n[r]=t[r]);return n}).default=o).__esModule=!0;var i={};function s(t,e){return((i=s=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t}).default=i).__esModule=!0,s(t,e)}((i=s).default=i).__esModule=!0;var c={};((c=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}).default=c).__esModule=!0;var a={};function l(t){return((a=l=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)}).default=a).__esModule=!0,l(t)}((a=l).default=a).__esModule=!0;var f={};((f=function(t){return-1!==Function.toString.call(t).indexOf("[native code]")}).default=f).__esModule=!0;var h={};((h=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}).default=h).__esModule=!0;var p={};function d(t,e,r){return h()?((p=d=Reflect.construct).default=p).__esModule=!0:((p=d=function(t,e,r){var n=[null];n.push.apply(n,e);n=new(Function.bind.apply(t,n));return r&&i(n,r.prototype),n}).default=p).__esModule=!0,d.apply(null,arguments)}((p=d).default=p).__esModule=!0;var m={};function v(t){var r="function"==typeof Map?new Map:void 0;return((m=v=function(t){if(null===t||!f(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(t))return r.get(t);r.set(t,e)}function e(){return p(t,arguments,a(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i(e,t)}).default=m).__esModule=!0,v(t)}((m=v).default=m).__esModule=!0;var y=u(c),g=function(e){function t(t){t=e.call(this,t)||this;return t.name="TimeoutError",t}return(0,y.default)(t,e),t}((0,u(m).default)(Error)),b=function(e){var r,t=new Promise(function(t){r=setTimeout(t,e)});return t.timeout=r,t},w={},_="object"==typeof Reflect?Reflect:null,x=_&&"function"==typeof _.apply?_.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)};var j=_&&"function"==typeof _.ownKeys?_.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)},P=Number.isNaN||function(t){return t!=t};function E(){E.init.call(this)}(w=E).once=function(a,u){return new Promise(function(t,e){function r(t){a.removeListener(u,n),e(t)}function n(){"function"==typeof a.removeListener&&a.removeListener("error",r),t([].slice.call(arguments))}var o,i,s;N(a,u,n,{once:!0}),"error"!==u&&(i=r,s={once:!0},"function"==typeof(o=a).on&&N(o,"error",i,s))})},(E.EventEmitter=E).prototype._events=void 0,E.prototype._eventsCount=0,E.prototype._maxListeners=void 0;var O=10;function S(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function L(t){return void 0===t._maxListeners?E.defaultMaxListeners:t._maxListeners}function k(t,e,r,n){var o,i;return S(r),void 0===(o=t._events)?(o=t._events=Object.create(null),t._eventsCount=0):(void 0!==o.newListener&&(t.emit("newListener",e,r.listener||r),o=t._events),i=o[e]),void 0===i?(i=o[e]=r,++t._eventsCount):("function"==typeof i?i=o[e]=n?[r,i]:[i,r]:n?i.unshift(r):i.push(r),0<(r=L(t))&&i.length>r&&!i.warned&&(i.warned=!0,(r=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",r.emitter=t,r.type=e,r.count=i.length,r=r,console&&console.warn&&console.warn(r))),t}function A(t,e,r){t={fired:!1,wrapFn:void 0,target:t,type:e,listener:r},e=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(t);return e.listener=r,t.wrapFn=e}function C(t,e,r){t=t._events;if(void 0===t)return[];e=t[e];return void 0===e?[]:"function"==typeof e?r?[e.listener||e]:[e]:r?function(t){for(var e=new Array(t.length),r=0;r<e.length;++r)e[r]=t[r].listener||t[r];return e}(e):T(e,e.length)}function M(t){var e=this._events;if(void 0!==e){t=e[t];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function T(t,e){for(var r=new Array(e),n=0;n<e;++n)r[n]=t[n];return r}function N(r,n,o,i){if("function"==typeof r.on)i.once?r.once(n,o):r.on(n,o);else{if("function"!=typeof r.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r);r.addEventListener(n,function t(e){i.once&&r.removeEventListener(n,t),o(e)})}}Object.defineProperty(E,"defaultMaxListeners",{enumerable:!0,get:function(){return O},set:function(t){if("number"!=typeof t||t<0||P(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");O=t}}),E.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},E.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||P(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},E.prototype.getMaxListeners=function(){return L(this)},E.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var n,o="error"===t,i=this._events;if(void 0!==i)o=o&&void 0===i.error;else if(!o)return!1;if(o){if((n=0<e.length?e[0]:n)instanceof Error)throw n;o=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw o.context=n,o}i=i[t];if(void 0===i)return!1;if("function"==typeof i)x(i,this,e);else for(var s=i.length,a=T(i,s),r=0;r<s;++r)x(a[r],this,e);return!0},E.prototype.addListener=function(t,e){return k(this,t,e,!1)},E.prototype.on=E.prototype.addListener,E.prototype.prependListener=function(t,e){return k(this,t,e,!0)},E.prototype.once=function(t,e){return S(e),this.on(t,A(this,t,e)),this},E.prototype.prependOnceListener=function(t,e){return S(e),this.prependListener(t,A(this,t,e)),this},E.prototype.removeListener=function(t,e){var r,n,o,i,s;if(S(e),void 0===(n=this._events))return this;if(void 0===(r=n[t]))return this;if(r===e||r.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(o=-1,i=r.length-1;0<=i;i--)if(r[i]===e||r[i].listener===e){s=r[i].listener,o=i;break}if(o<0)return this;0===o?r.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(r,o),1===r.length&&(n[t]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",t,s||e)}return this},E.prototype.off=E.prototype.removeListener,E.prototype.removeAllListeners=function(t){var e,r=this._events;if(void 0===r)return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[t]),this;if(0===arguments.length){for(var n,o=Object.keys(r),i=0;i<o.length;++i)"removeListener"!==(n=o[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(void 0!==e)for(i=e.length-1;0<=i;i--)this.removeListener(t,e[i]);return this},E.prototype.listeners=function(t){return C(this,t,!0)},E.prototype.rawListeners=function(t){return C(this,t,!1)},E.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):M.call(t,e)},E.prototype.listenerCount=M,E.prototype.eventNames=function(){return 0<this._eventsCount?j(this._events):[]};var R={};R.EventEmitter=w,R.timeout=function(t,e){var r=b(e);return Promise.race([t.finally(function(){clearTimeout(r.timeout)}),r.then(function(){throw new g})])},R.promise=function(s,a,u,c){return void 0===u&&(u="error"),new Promise(function(e,r){var t,n=function(){clearTimeout(t),s.removeListener(a,i),s.removeListener(u,o)};function o(t){r(t),n()}function i(t){e(t),n()}s.once(a,i),u&&s.once(u,o),c&&(t=setTimeout(function(){n(),r(new g)},c))})},R.Deferred=function(){var r=this;this.promise=new Promise(function(t,e){r.resolve=t,r.reject=e})};var q={detect:function(t){return!!t&&-1!==t.replace(/\\20/g,"").replace(/\\22/g,"").replace(/\\26/g,"").replace(/\\27/g,"").replace(/\\2f/g,"").replace(/\\3a/g,"").replace(/\\3c/g,"").replace(/\\3e/g,"").replace(/\\40/g,"").replace(/\\5c/g,"").search(/[ "&'/:<>@\\]/g)},escape:function(t){return null===t?null:t.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40").replace(/\3a/g,"c3a")},unescape:function(t){return null===t?null:t.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")}},X=function(t){function e(t,e,r){if("string"!=typeof e||!e)throw new TypeError("Invalid domain.");this.setDomain(e),this.setLocal("string"==typeof t?t:""),this.setResource("string"==typeof r?r:"")}var r=e.prototype;return r[t]=function(t){return"number"===t?NaN:this.toString()},r.toString=function(t){var e=this._domain;return this._local&&(e=this.getLocal(t)+"@"+e),e=this._resource?e+"/"+this._resource:e},r.bare=function(){return this._resource?new e(this._local,this._domain,null):this},r.equals=function(t){return this._local===t._local&&this._domain===t._domain&&this._resource===t._resource},r.setLocal=function(t,e){return(e=e||q.detect(t))&&(t=q.escape(t)),this._local=t&&t.toLowerCase(),this},r.getLocal=function(t){return(t=void 0===t?!1:t)?q.unescape(this._local):this._local},r.setDomain=function(t){return this._domain=t.toLowerCase(),this},r.getDomain=function(){return this._domain},r.setResource=function(t){return this._resource=t,this},r.getResource=function(){return this._resource},e}(Symbol.toPrimitive);Object.defineProperty(X.prototype,"local",{get:X.prototype.getLocal,set:X.prototype.setLocal}),Object.defineProperty(X.prototype,"domain",{get:X.prototype.getDomain,set:X.prototype.setDomain}),Object.defineProperty(X.prototype,"resource",{get:X.prototype.getResource,set:X.prototype.setResource});var I=X,F=function(t){var e,r,n=t.indexOf("/");-1!==n&&(r=t.slice(n+1),t=t.slice(0,n));n=t.indexOf("@");return-1!==n&&(e=t.slice(0,n),t=t.slice(n+1)),new I(e,t,r)},z={},D=u(p);function B(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return e[1]||e[2]?(0,D.default)(I,e):F.apply(void 0,e)}(z=B.bind()).jid=B,z.JID=I,z.equal=function(t,e){return t.equals(e)},z.detectEscape=q.detect,z.escapeLocal=q.escape,z.unescapeLocal=q.unescape,z.parse=F;var U={},$={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};function W(t){return $[t]}var H={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};function J(t){if("#"===t[1]){var e="x"===t[2]?parseInt(t.slice(3),16):parseInt(t.slice(2),10);if(9===e||10===e||13===e||32<=e&&e<=55295||57344<=e&&e<=65533||65536<=e&&e<=1114111)return String.fromCodePoint(e);throw new Error("Illegal XML character 0x"+e.toString(16))}if(H[t])return H[t]||t;throw new Error("Illegal XML entity "+t)}U.escapeXML=function(t){return t.replace(/&|<|>|"|'/g,W)},U.unescapeXML=function(t){for(var e,r="",n=-1,o=0;-1!==(e=t.indexOf("&",o))&&-1!==(n=t.indexOf(";",e+1));)r=r+t.substring(o,e)+J(t.substring(e,n+1)),o=n+1;return 0===o?t:r+=t.substring(o)},U.escapeXMLText=function(t){return t.replace(/&|<|>/g,W)},U.unescapeXMLText=function(t){return t.replace(/&(amp|#38|lt|#60|gt|#62);/g,J)};t={};function K(t,e){return t.name===e.name}function Y(t,e){var r=t.attrs,n=Object.keys(r),t=n.length;if(t!==Object.keys(e.attrs).length)return!1;for(var o=0,i=t;o<i;o++){var s=n[o],a=r[s];if(null==a||null==e.attrs[s]){if(a!==e.attrs[s])return!1}else if(a.toString()!==e.attrs[s].toString())return!1}return!0}function G(t,e){var r=t.children,t=r.length;if(t!==e.children.length)return!1;for(var n=0,o=t;n<o;n++){var i=r[n];if("string"==typeof i){if(i!==e.children[n])return!1}else if(!i.equals(e.children[n]))return!1}return!0}t.name=K,t.attrs=Y,t.children=G,t.equal=function(t,e){return!!K(t,e)&&(!!Y(t,e)&&!!G(t,e))};var Q=U.escapeXML,V=U.escapeXMLText,Z=t.equal,tt=t.name,et=t.attrs,rt=t.children;function nt(t,e){this.name=t,this.parent=null,this.children=[],this.attrs={},this.setAttrs(e)}nt.prototype.is=function(t,e){return this.getName()===t&&(!e||this.getNS()===e)},nt.prototype.getName=function(){return 0<=this.name.indexOf(":")?this.name.substr(this.name.indexOf(":")+1):this.name},nt.prototype.getNS=function(){if(0<=this.name.indexOf(":")){var t=this.name.substr(0,this.name.indexOf(":"));return this.findNS(t)}return this.findNS()},nt.prototype.findNS=function(t){if(t){var e="xmlns:"+t;return this.attrs[e]?this.attrs[e]:this.parent?this.parent.findNS(t):void 0}return this.attrs.xmlns||(this.parent?this.parent.findNS():void 0)},nt.prototype.getXmlns=function(){var t,e={};for(t in this.parent&&(e=this.parent.getXmlns()),this.attrs){var r=t.match("xmlns:?(.*)");this.attrs.hasOwnProperty(t)&&r&&(e[this.attrs[t]]=r[1])}return e},nt.prototype.setAttrs=function(e){"string"==typeof e?this.attrs.xmlns=e:e&&Object.keys(e).forEach(function(t){this.attrs[t]=e[t]},this)},nt.prototype.getAttr=function(t,e){if(!e)return this.attrs[t];var r=this.getXmlns();return r[e]?this.attrs[[r[e],t].join(":")]:null},nt.prototype.getChild=function(t,e){return this.getChildren(t,e)[0]},nt.prototype.getChildren=function(t,e){for(var r=[],n=0;n<this.children.length;n++){var o=this.children[n];!o.getName||o.getName()!==t||e&&o.getNS()!==e||r.push(o)}return r},nt.prototype.getChildByAttr=function(t,e,r,n){return this.getChildrenByAttr(t,e,r,n)[0]},nt.prototype.getChildrenByAttr=function(t,e,r,n){for(var o=[],i=0;i<this.children.length;i++){var s=this.children[i];!s.attrs||s.attrs[t]!==e||r&&s.getNS()!==r||o.push(s),n&&s.getChildrenByAttr&&o.push(s.getChildrenByAttr(t,e,r,!0))}return o=n?[].concat.apply([],o):o},nt.prototype.getChildrenByFilter=function(t,e){for(var r=[],n=0;n<this.children.length;n++){var o=this.children[n];t(o)&&r.push(o),e&&o.getChildrenByFilter&&r.push(o.getChildrenByFilter(t,!0))}return r=e?[].concat.apply([],r):r},nt.prototype.getText=function(){for(var t="",e=0;e<this.children.length;e++){var r=this.children[e];"string"!=typeof r&&"number"!=typeof r||(t+=r)}return t},nt.prototype.getChildText=function(t,e){e=this.getChild(t,e);return e?e.getText():null},nt.prototype.getChildElements=function(){return this.getChildrenByFilter(function(t){return t instanceof nt})},nt.prototype.tree=nt.prototype.root=function(){return this.parent?this.parent.root():this},nt.prototype.up=function(){return this.parent||this},nt.prototype.c=function(t,e){return this.cnode(new nt(t,e))},nt.prototype.cnode=function(t){return this.children.push(t),"object"==typeof t&&(t.parent=this),t},nt.prototype.t=function(t){return this.children.push(t),this},nt.prototype.remove=function(e,r){var t="string"==typeof e?function(t){return!(t.is&&t.is(e,r))}:function(t){return t!==e};return this.children=this.children.filter(t),this},nt.prototype.clone=function(){return function(t){for(var e=new t.constructor(t.name,t.attrs),r=0;r<t.children.length;r++){var n=t.children[r];e.cnode(n.clone?n.clone():n)}return e}(this)},nt.prototype.text=function(t){return t&&1===this.children.length?(this.children[0]=t,this):this.getText()},nt.prototype.attr=function(t,e){return void 0!==e||null===e?(this.attrs||(this.attrs={}),this.attrs[t]=e,this):this.attrs[t]},nt.prototype.toString=function(){var e="";return this.write(function(t){e+=t}),e},nt.prototype.toJSON=function(){return{name:this.name,attrs:this.attrs,children:this.children.map(function(t){return t&&t.toJSON?t.toJSON():t})}},nt.prototype._addChildren=function(t){t(">");for(var e=0;e<this.children.length;e++){var r=this.children[e];!r&&0!==r||(r.write?r.write(t):"string"==typeof r?t(V(r)):r.toString&&t(V(r.toString(10))))}t("</"),t(this.name),t(">")},nt.prototype.write=function(t){for(var e in t("<"),t(this.name),this.attrs){var r=this.attrs[e];null!=r&&(t(" "),t(e),t('="'),"string"!=typeof r&&(r=r.toString()),t(Q(r)),t('"'))}0===this.children.length?t("/>"):this._addChildren(t)},nt.prototype.nameEquals=function(t){return tt(this,t)},nt.prototype.attrsEquals=function(t){return et(this,t)},nt.prototype.childrenEquals=function(t){return rt(this,t)},nt.prototype.equals=function(t){return Z(this,t)};var _=nt,ot=u(c);function it(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return st(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?st(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function st(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var at=function(t){function e(){return t.apply(this,arguments)||this}(0,ot.default)(e,t);var r=e.prototype;return r.setAttrs=function(t){if("string"==typeof t)this.attrs.xmlns=t;else if(t)for(var e=0,r=Object.keys(t);e<r.length;e++){var n,o=r[e];"__source"!==o&&"__self"!==o&&(null!=(n=t[o])&&(this.attrs[o.toString()]=n.toString()))}},r.append=function(t){for(var e=it(t=Array.isArray(t)?t:[t]);!(r=e()).done;){var r=r.value;this.children.push(r),"object"==typeof r&&(r.parent=this)}return this},r.prepend=function(t){for(var e=it(t=Array.isArray(t)?t:[t]);!(r=e()).done;){var r=r.value;this.children.unshift(r),"object"==typeof r&&(r.parent=this)}return this},e}(_);function ut(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return ct(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ct(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function ct(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var lt=function(t,e){for(var r=new at(t,e),n=0;n<(arguments.length<=2?0:arguments.length-2);n++)!function t(e,r){if(!1!==r&&null!=r)if(r instanceof at)e.append(r);else if(Array.isArray(r))for(var n,o=ut(r);!(n=o()).done;)t(e,n.value);else e.append(String(r))}(r,n+2<2||arguments.length<=n+2?void 0:arguments[n+2]);return r},X={};((X=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}).default=X).__esModule=!0;var ft,t={},t="function"==typeof Object.create?function(t,e){e&&(t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:function(t,e){var r;e&&(t.super_=e,(r=function(){}).prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t)},ht=w.EventEmitter,pt=U.unescapeXML,dt=0,mt=1,vt=2,yt=3,gt=4,bt=5,wt=6,_t=7,xt=8,jt=9,Pt=10,_=ft=function(){ht.call(this);var c,l,f,h,p,d,m,v,y=dt,g=0;this._handleTagOpening=function(t,e,r){t?this.emit("endElement",e):(this.emit("startElement",e,r),p&&this.emit("endElement",e))},this.write=function(e){"string"!=typeof e&&(e=e.toString());var t,r,n=0;function o(){if("number"==typeof g){var t=e.substring(g,n);return g=void 0,t}}for(c&&(e=c+e,n+=c.length,c=null);n<e.length;n++){y===dt?-1!==(t=e.indexOf("<",n))&&n!==t&&(n=t):y===xt?-1!==(t=e.indexOf(m,n))&&(n=t):y===mt?-1!==(r=e.indexOf("--\x3e",n))&&(n=r+2):y!==Pt||-1!==(r=e.indexOf("]]>",n))&&(n=r+2);var i,s,a,u=e.charCodeAt(n);switch(y){case dt:60===u&&((i=o())&&this.emit("text",pt(i)),y=yt,g=n+1,f={});break;case jt:93===u&&"]>"===e.substr(n+1,2)&&((s=o())&&this.emit("text",s),y=dt);break;case yt:47===u&&g===n?(g=n+1,h=!0):33===u?y="[CDATA["===e.substr(n+1,7)?(g=n+8,jt):(g=void 0,mt):63===u?(g=void 0,y=vt):(u<=32||47===u||62===u)&&(l=o(),n--,y=gt);break;case mt:62===u&&(s=e.charCodeAt(n-1),a=e.charCodeAt(n-2),(45===s&&45===a||93===s&&93===a)&&(y=dt));break;case vt:62===u&&63===e.charCodeAt(n-1)&&(y=dt);break;case gt:62===u?(this._handleTagOpening(h,l,f),p=h=f=l=void 0,y=dt,g=n+1):47===u?p=!0:32<u&&(g=n,y=bt);break;case bt:(u<=32||61===u)&&(v=o(),n--,y=wt);break;case wt:61===u&&(y=_t);break;case _t:34!==u&&39!==u||(m=34===(d=u)?'"':"'",y=xt,g=n+1);break;case xt:u===d&&(a=pt(o()),f[v]=a,v=void 0,y=gt)}}"number"==typeof g&&g<=e.length&&(c=e.slice(g),g=0)}};t(_,ht),_.prototype.end=function(t){t&&this.write(t),this.write=function(){}};var Et=u(c),Ot=function(o){function t(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(t=o.call.apply(o,[this].concat(r))||this).name="XMLError",t}return(0,Et.default)(t,o),t}((0,u(m).default)(Error)),St=u(X),Lt=u(c),t=function(r){function t(){var t=r.call(this)||this,e=new ft;return t.root=null,t.cursor=null,e.on("startElement",t.onStartElement.bind((0,St.default)(t))),e.on("endElement",t.onEndElement.bind((0,St.default)(t))),e.on("text",t.onText.bind((0,St.default)(t))),t.parser=e,t}(0,Lt.default)(t,r);var e=t.prototype;return e.onStartElement=function(t,e){var r=new at(t,e),t=this.root,e=this.cursor;t?e!==t&&e.append(r):(this.root=r,this.emit("start",r)),this.cursor=r},e.onEndElement=function(t){var e=this.root,r=this.cursor;if(t===r.name){if(r!==e)return r.parent?void(this.cursor=r.parent):(r.parent=e,this.emit("element",r),void(this.cursor=e));this.emit("end",e)}else this.emit("error",new Ot(r.name+" must be closed."))},e.onText=function(t){var e=this.cursor;e?e.t(t):this.emit("error",new Ot(t+" must be a child."))},e.write=function(t){this.parser.write(t)},e.end=function(t){t&&this.parser.write(t)},t}(w);t.XMLError=Ot;var kt=t,At={},_=U.escapeXML,X=U.unescapeXML,t=U.escapeXMLText,U=U.unescapeXMLText;At=function(){return lt.apply(void 0,arguments)},Object.assign(At,{x:lt,Element:at,Parser:kt,escapeXML:_,unescapeXML:X,escapeXMLText:t,unescapeXMLText:U,XMLError:Ot});var Ct=u(c),_=function(o){function t(t,e,r){var n=o.call(this,t+(e?" - "+e:""))||this;return n.name="XMPPError",n.condition=t,n.text=e,n.application=r,n}return(0,Ct.default)(t,o),t.fromElement=function(t){var e,r=t.children,n=r[0],o=r[1],r=r[2];o&&(o.is("text")?e=o:o&&(i=o),r&&(i=r));var i=new this(n.name,e?e.text():"",i);return i.element=t,i},t}((0,u(m).default)(Error)),Mt=u(c),Tt=function(o){function t(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(t=o.call.apply(o,[this].concat(r))||this).name="StreamError",t}return(0,Mt.default)(t,o),t}(_),X={};function Nt(t){var e=new URL(t),r=e.port,t=e.hostname;return{port:r,hostname:t="[::1]"===t?"::1":t,protocol:e.protocol}}function Rt(t){t=Nt("http://"+t);return{port:t.port,hostname:t.hostname}}Object.assign(X,{parseURI:Nt,parseHost:Rt,parseService:function(t){return(t.includes("://")?Nt:Rt)(t)}});var qt=u(c);function Xt(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}function It(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return Ft(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ft(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Ft(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function zt(){}var t=R.EventEmitter,Dt=R.promise;function Bt(t,e){if(!e)return t&&t.then?t.then(zt):Promise.resolve()}function Ut(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}function $t(t,e){return t&&t.then?t.then(e):e(t)}var Wt=X.parseHost,Ht=X.parseService,U=function(r){function t(t){var e;return void 0===t&&(t={}),(e=r.call(this)||this).jid=null,e.timeout=2e3,e.options=t,e.socketListeners=Object.create(null),e.parserListeners=Object.create(null),e.status="offline",e.socket=null,e.parser=null,e.root=null,e}(0,qt.default)(t,r);var e=t.prototype;return e._reset=function(){this.jid=null,this.status="offline",this._detachSocket(),this._detachParser()},e._streamError=function(t,e){try{var r=this;return $t(Ut(function(){return Bt(r.send(At("stream:error",{},[At(t,{xmlns:"urn:ietf:params:xml:ns:xmpp-streams"},e)])))},zt),function(){return r._end()})}catch(t){return Promise.reject(t)}},e._onData=function(t){t=t.toString("utf8");this.emit("input",t),this.parser.write(t)},e._onParserError=function(t){this._streamError("bad-format"),this._detachParser(),this.emit("error",t)},e._attachSocket=function(t){var r=this;this.socket=t;t=this.socketListeners;t.data=this._onData.bind(this),t.close=function(t,e){r._reset(),r._status("disconnect",{clean:!t,event:e})},t.connect=function(){r._status("connect")},t.error=function(t){r.emit("error",t)},this.socket.on("close",t.close),this.socket.on("data",t.data),this.socket.on("error",t.error),this.socket.on("connect",t.connect)},e._detachSocket=function(){for(var t=this.socketListeners,e=this.socket,r=It(Object.getOwnPropertyNames(t));!(n=r()).done;){var n=n.value;e.removeListener(n,t[n]),delete t[n]}return this.socket=null,e},e._onElement=function(t){var e=t.is("error","http://etherx.jabber.org/streams");e&&this._onStreamError(t),this.emit("element",t),this.emit(this.isStanza(t)?"stanza":"nonza",t),e&&this._end()},e._onStreamError=function(t){t=Tt.fromElement(t);if("see-other-host"===t.condition)return this._onSeeOtherHost(t);this.emit("error",t)},e._onSeeOtherHost=function(t){try{var n=this,e=Ht(n.options.service).protocol,r=t.element.getChildText("see-other-host"),o=Wt(r).port?(e||"xmpp:")+"//"+r:(e?e+"//":"")+r;return function(t){if(t&&t.then)return t.then(zt)}(Ut(function(){return Xt(Dt(n,"disconnect"),function(){var t=n.options,e=t.domain,r=t.lang;return Xt(n.connect(o),function(){return Bt(n.open({domain:e,lang:r}))})})},function(t){n.emit("error",t)}))}catch(t){return Promise.reject(t)}},e._attachParser=function(t){var e=this;this.parser=t;t=this.parserListeners;t.element=this._onElement.bind(this),t.error=this._onParserError.bind(this),t.end=function(t){e._detachParser(),e._status("close",t)},t.start=function(t){e._status("open",t)},this.parser.on("error",t.error),this.parser.on("element",t.element),this.parser.on("end",t.end),this.parser.on("start",t.start)},e._detachParser=function(){for(var t=this.parserListeners,e=It(Object.getOwnPropertyNames(t));!(r=e()).done;){var r=r.value;this.parser.removeListener(r,t[r]),delete t[r]}this.parser=null},e._jid=function(t){return this.jid=z(t),this.jid},e._status=function(t){this.status=t;for(var e=arguments.length,r=new Array(1<e?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this.emit.apply(this,["status",t].concat(r)),this.emit.apply(this,[t].concat(r))},e._end=function(){try{var e,t=this;return $t(Ut(function(){return Xt(t.close(),function(t){e=t})},zt),function(){return $t(Ut(function(){return Bt(t.disconnect())},zt),function(){return e})})}catch(t){return Promise.reject(t)}},e.start=function(){try{var e=this;if("offline"!==e.status)throw new Error("Connection is not offline");var t=e.options,r=t.service,n=t.domain,o=t.lang;return Xt(e.connect(r),function(){var t=Dt(e,"online");return Xt(e.open({domain:n,lang:o}),function(){return t})})}catch(t){return Promise.reject(t)}},e.connect=function(t){try{this._status("connecting",t);var e=new this.Socket;return this._attachSocket(e),e.connect(this.socketParameters(t)),Dt(e,"connect")}catch(t){return Promise.reject(t)}},e.disconnect=function(t){try{var e=this;return void 0===t&&(t=e.timeout),e.socket&&e._status("disconnecting"),e.socket.end(),Bt(Dt(e.socket,"close","error",t))}catch(t){return Promise.reject(t)}},e.open=function(t){try{var e=this;e._status("opening");var r=t="string"==typeof t?{domain:t}:t,n=r.domain,o=r.lang,i=r.timeout,s=void 0===i?e.timeout:i,a=e.headerElement();return a.attrs.to=n,a.attrs["xml:lang"]=o,e.root=a,e._attachParser(new e.Parser),Xt(e.write(e.header(a)),function(){return Dt(e,"open","error",s)})}catch(t){return Promise.reject(t)}},e.stop=function(){try{var e=this;return Xt(e._end(),function(t){return"offline"!==e.status&&e._status("offline",t),t})}catch(t){return Promise.reject(t)}},e.close=function(t){try{var e=this;void 0===t&&(t=e.timeout);var r=e.footer(e.footerElement()),n=Promise.all([Dt(e.parser,"end","error",t),e.write(r)]);return e.parser&&e.socket&&e._status("closing"),Xt(n,function(t){t=t[0];return e.root=null,t})}catch(t){return Promise.reject(t)}},e.restart=function(){try{this._detachParser();var t=this.options,e=t.domain,r=t.lang;return this.open({domain:e,lang:r})}catch(t){return Promise.reject(t)}},e.send=function(){for(var t=arguments.length,r=new Array(t),e=0;e<t;e++)r[e]=arguments[e];try{for(var n=this,o="",i=0,s=r;i<s.length;i++){var a=s[i];a.parent=n.root,o+=a.toString()}return Xt(n.write(o),function(){for(var t=It(r);!(e=t()).done;){var e=e.value;n.emit("send",e)}})}catch(t){return Promise.reject(t)}},e.sendReceive=function(t,e){return void 0===e&&(e=this.timeout),Promise.all([this.send(t),Dt(this,"element","error",e)]).then(function(t){return t[1]})},e.write=function(n){var o=this;return new Promise(function(e,r){"closing"!==o.status?o.socket.write(n,function(t){return t?r(t):(o.emit("output",n),void e())}):r(new Error("Connection is closing"))})},e.isStanza=function(t){t=t.name;return"iq"===t||"message"===t||"presence"===t},e.isNonza=function(t){return!this.isStanza(t)},e.header=function(t){return t.toString()},e.headerElement=function(){return new At.Element("",{version:"1.0",xmlns:this.NS})},e.footer=function(t){return t.toString()},e.footerElement=function(){},e.socketParameters=function(){},t}(t);U.prototype.NS="",U.prototype.Socket=null,U.prototype.Parser=null;var X=U,Jt=u(c),t=function(r){function t(t){t=r.call(this,t)||this;return t.transports=[],t}(0,Jt.default)(t,r);var e=t.prototype;return e.send=function(t){for(var e,r=arguments.length,n=new Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return(e=this.Transport.prototype.send).call.apply(e,[this,t].concat(n))},e._findTransport=function(e){return this.transports.find(function(t){try{return void 0!==t.prototype.socketParameters(e)}catch(t){return!1}})},e.connect=function(t){var e=this._findTransport(t);if(!e)throw new Error("No compatible connection method found.");return this.Transport=e,this.Socket=e.prototype.Socket,this.Parser=e.prototype.Parser,r.prototype.connect.call(this,t)},e.socketParameters=function(){var t;return(t=this.Transport.prototype).socketParameters.apply(t,arguments)},e.header=function(){var t;return(t=this.Transport.prototype).header.apply(t,arguments)},e.headerElement=function(){var t;return(t=this.Transport.prototype).headerElement.apply(t,arguments)},e.footer=function(){var t;return(t=this.Transport.prototype).footer.apply(t,arguments)},e.footerElement=function(){var t;return(t=this.Transport.prototype).footerElement.apply(t,arguments)},t}(X);t.prototype.NS="jabber:client";U={};U.Client=t,U.xml=At,U.jid=z;var Kt=function(t){return(t.split("://")[1]||t).split(":")[0].split("/")[0]},Yt=u(c);function Gt(){}var Qt=function(r){function t(t){var e=r.call(this)||this;return e.delay=1e3,e.entity=t,e._timeout=null,e}(0,Yt.default)(t,r);var e=t.prototype;return e.scheduleReconnect=function(){var r,t=this,e=this.entity,n=this.delay,o=this._timeout;clearTimeout(o),this._timeout=setTimeout((r=function(){if("disconnect"===e.status)return function(t){if(t&&t.then)return t.then(Gt)}(function(t,e){try{var r=t()}catch(t){return e(t)}if(r&&r.then)return r.then(void 0,e);return r}(function(){return function(t,e){if(!e)return t&&t.then?t.then(Gt):Promise.resolve()}(t.reconnect())},Gt))},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}),n)},e.reconnect=function(){try{var t=this,e=t.entity;t.emit("reconnecting");var r=e.options,n=r.service,o=r.domain,i=r.lang;return Vt(e.connect(n),function(){return Vt(e.open({domain:o,lang:i}),function(){t.emit("reconnected")})})}catch(t){return Promise.reject(t)}},e.start=function(){var t=this,e=this.entity,r={disconnect:function(){t.scheduleReconnect()}};this.listeners=r,e.on("disconnect",r.disconnect)},e.stop=function(){var t=this.entity,e=this.listeners,r=this._timeout;t.removeListener("disconnect",e.disconnect),clearTimeout(r)},t}(R.EventEmitter);function Vt(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var Zt=function(t){t=t.entity,t=new Qt(t);return t.start(),t},te={},ee={};!function(t){!function(){"use strict";var n=u(c);function o(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return i(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var s=t.WebSocket||te,a="ECONNERROR";ee=function(e){function t(){var t=e.call(this)||this;return t.listeners=Object.create(null),t}(0,n.default)(t,e);var r=t.prototype;return r.connect=function(t){this.url=t,this._attachSocket(new s(t,["xmpp"]))},r._attachSocket=function(t){var n=this;this.socket=t;t=this.listeners;t.open=function(){n.emit("connect")},t.message=function(t){t=t.data;return n.emit("data",t)},t.error=function(t){var e=n.url,r=t.error;r||((r=new Error("WebSocket "+a+" "+e)).errno=a,r.code=a),r.event=t,r.url=e,n.emit("error",r)},t.close=function(t){n._detachSocket(),n.emit("close",!t.wasClean,t)},this.socket.addEventListener("open",t.open),this.socket.addEventListener("message",t.message),this.socket.addEventListener("error",t.error),this.socket.addEventListener("close",t.close)},r._detachSocket=function(){delete this.url;for(var t=this.socket,e=this.listeners,r=o(Object.getOwnPropertyNames(e));!(n=r()).done;){var n=n.value;t.removeEventListener(n,e[n]),delete e[n]}delete this.socket},r.end=function(){this.socket.close()},r.write=function(t,e){s===te?this.socket.send(t,e):(this.socket.send(t),e())},t}(w)}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var re=u(c),t=At.Parser,ne=At.Element,oe=At.XMLError,t=function(t){function e(){return t.apply(this,arguments)||this}(0,re.default)(e,t);var r=e.prototype;return r.onStartElement=function(t,e){t=new ne(t,e),e=this.cursor;e&&e.append(t),this.cursor=t},r.onEndElement=function(t){var e=this.cursor;t===e.name?e.parent?this.cursor=e.parent:(e.is("open","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("start",e):e.is("close","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("end",e):this.emit("element",e),this.cursor=null):this.emit("error",new oe(e.name+" must be closed."))},e}(t),ie=u(c),se="urn:ietf:params:xml:ns:xmpp-framing",X=function(i){function t(){return i.apply(this,arguments)||this}(0,ie.default)(t,i);var e=t.prototype;return e.send=function(t){var e;!t.attrs.xmlns&&i.prototype.isStanza.call(this,t)&&(t.attrs.xmlns="jabber:client");for(var r=arguments.length,n=new Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return(e=i.prototype.send).call.apply(e,[this,t].concat(n))},e.footerElement=function(){return new At.Element("close",{xmlns:se})},e.headerElement=function(){var t=i.prototype.headerElement.call(this);return t.name="open",t.attrs.xmlns=se,t},e.socketParameters=function(t){return/^wss?:\/\//.test(t)?t:void 0},t}(X);X.prototype.Socket=ee,X.prototype.NS="jabber:client",X.prototype.Parser=t;var ae=X,ue=function(t){t.entity.transports.push(ae)};function ce(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return le(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?le(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function le(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var fe=function(s){if(!Array.isArray(s))throw new TypeError("Middleware stack must be an array!");for(var t,e=ce(s);!(t=e()).done;)if("function"!=typeof t.value)throw new TypeError("Middleware must be composed of functions!");return function(r,n){var o=-1;return i(0);function i(t){if(t<=o)return Promise.reject(new Error("next() called multiple times"));var e=s[o=t];if(!(e=t===s.length?n:e))return Promise.resolve();try{return Promise.resolve(e(r,i.bind(null,t+1)))}catch(t){return Promise.reject(t)}}}};var X=function(t,e){this.stanza=e,this.entity=t;var r=e.name,t=e.attrs,e=t.type,t=t.id;this.name=r,this.id=t||"",this.type="message"===r?e||"normal":"presence"===r?e||"available":e||"",this.from=null,this.to=null,this.local="",this.domain="",this.resource=""},he=u(c),pe=function(o){function t(t,e){var r=o.call(this,t,e)||this,n=t.jid,t=t.domain,n=e.attrs.to||n&&n.toString(),t=e.attrs.from||t;return n&&(r.to=new z(n)),t&&(r.from=new z(t),r.local=r.from.local,r.domain=r.from.domain,r.resource=r.from.resource),r}return(0,he.default)(t,o),t}(X),de=u(c),me=function(o){function t(t,e){var r=o.call(this,t,e)||this,n=t.jid,t=t.domain,n=e.attrs.from||n&&n.toString(),t=e.attrs.to||t;return n&&(r.from=new z(n)),t&&(r.to=new z(t),r.local=r.to.local,r.domain=r.to.domain,r.resource=r.to.resource),r}return(0,de.default)(t,o),t}(X);function ve(e,r,n){return function(t){t=new n(e,t);return fe(r)(t)}}var ye=function(t){var r,e=t.entity,n=[function(t,e){e().then(function(t){return t&&r.send(t)}).catch(function(t){return r.emit("error",t)})}],o=[],i=ve(r=e,n,pe),t=ve(e,o,me);return e.on("element",i),e.hookOutgoing=t,{use:function(t){return n.push(t),t},filter:function(t){return o.push(t),t}}};var ge=function(){return r=function(t,e){var r=t.stanza,n=t.entity;return r.is("features","http://etherx.jabber.org/streams")?function(t,e,r){if(r)return e?e(t()):t();try{var n=Promise.resolve(t());return e?n.then(e):n}catch(t){return Promise.reject(t)}}(e,function(t){!t&&n.jid&&n._status("online",n.jid)}):e()},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}};var r},be=function(t){var e=t.middleware;return e.use(ge()),{use:function(n,o,i){return e.use(function(t,e){var r=t.stanza;if(!r.is("features","http://etherx.jabber.org/streams"))return e();r=r.getChild(n,o);return r?i(t,e,r):e()})}}},we=u(c),_e=function(o){function t(t,e,r,n){r=o.call(this,t,e,r)||this;return r.type=n,r.name="StanzaError",r}return(0,we.default)(t,o),t.fromElement=function(t){var e=o.fromElement.call(this,t);return e.type=t.attrs.type,e},t}(_),xe=u(p);function je(){}var Pe=R.Deferred;var Ee=R.timeout;var Oe=function(){function t(t){var e=t.entity,t=t.middleware;this.handlers=new Map,this.entity=e,this.middleware=t}var e=t.prototype;return e.start=function(){this.middleware.use(this._route.bind(this))},e._route=function(t,e){var r=t.type,n=t.name,o=t.id,i=t.stanza;if(n=(t={name:n,type:r}).name,t=t.type,"iq"!==n||"error"!==t&&"result"!==t)return e();t=this.handlers.get(o);if(!t)return e();"error"===r?t.reject(_e.fromElement(i.getChild("error"))):t.resolve(i),this.handlers.delete(o)},e.request=function(n,o){void 0===o&&(o=3e4);try{var i=this;n.attrs.id||(n.attrs.id=function(){for(var t;!t;)t=Math.random().toString(36).slice(2,12);return t}());var s=new Pe;return i.handlers.set(n.attrs.id,s),t=function(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}(function(){return t=i.entity.send(n),e=function(){return function(t,e){if(!e)return t&&t.then?t.then(je):Promise.resolve()}(Ee(s.promise,o))},r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t);var t,e,r},function(t){throw i.handlers.delete(n.attrs.id),t}),e=function(t){return s.promise},t&&t.then?t.then(e):e(t)}catch(t){return Promise.reject(t)}var t,e},e._childRequest=function(t,e,r){for(var n=e.name,o=e.attrs.xmlns,i=arguments.length,s=new Array(3<i?i-3:0),a=3;a<i;a++)s[a-3]=arguments[a];return this.request.apply(this,[At("iq",{type:t,to:r},e)].concat(s)).then(function(t){return t.getChild(n,o)})},e.get=function(){try{for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this._childRequest.apply(this,["get"].concat(e))}catch(t){return Promise.reject(t)}},e.set=function(){try{for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this._childRequest.apply(this,["set"].concat(e))}catch(t){return Promise.reject(t)}},t}(),Se=function(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(t=(0,xe.default)(Oe,r)).start(),t};var Le="urn:ietf:params:xml:ns:xmpp-stanzas";function ke(t){t=t.stanza;return At("iq",{to:t.attrs.from,from:t.attrs.to,id:t.attrs.id})}function Ae(t,e,r){t=ke(t);return t.attrs.type="error",r&&t.append(r),t.append(e),t}function Ce(t,e){return At("error",{type:t},At(e,Le))}function Me(h){return function(r,t){try{if(f=(l=r).name,l=l.type,"iq"!==f||("error"===l||"result"===l))return t();var n,e=r.stanza.getChildElements(),o=e[0];return(u=e,c=o,"get"!==(a=(a=r).type)&&"set"!==a||(1!==u.length||!c))?Ae(r,Ce("modify","bad-request"),o):(r.element=o,i=function(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}(function(){return function(t,e,r){if(r)return e?e(t()):t();try{var n=Promise.resolve(t());return e?n.then(e):n}catch(t){return Promise.reject(t)}}(t,function(t){n=t})},function(t){h.emit("error",t),n=Ce("cancel","internal-server-error")}),s=function(){return(n=n||Ce("cancel","service-unavailable"))instanceof At.Element&&n.is("error")?Ae(r,n,o):(t=r,e=n instanceof At.Element?n:void 0,(t=ke(t)).attrs.type="result",e&&t.append(e),t);var t,e},i&&i.then?i.then(s):s(i))}catch(t){return Promise.reject(t)}var i,s,a,u,c,l,f}}function Te(r,n,o,i){return function(t,e){return t.type!==r|!t.element||!t.element.is(o,n)?e():i(t,e)}}var Ne=function(t){var n=t.middleware,t=t.entity;return n.use(Me(t)),{get:function(t,e,r){n.use(Te("get",t,e,r))},set:function(t,e,r){n.use(Te("set",t,e,r))}}},Re={};function qe(t){return t.startsWith("https")||t.startsWith("wss")}Re.compare=function(t,e){var r=qe(t.uri)&&!qe(e.uri)?-1:!qe(t.uri)&&qe(e.uri)?1:0;return 0!==r?r:0!==(e=t.method===e.method?0:"websocket"===t.method?-1:"websocket"===e.method?1:"xbosh"===t.method?-1:"xbosh"===e.method?1:"httppoll"===t.method?-1:"httppoll"===e.method?1:0)?e:0};var Xe={};!function(t){!function(){"use strict";var e=t.fetch||te,r=Re.compare;Xe.resolve=function(t){return e("https://"+t+"/.well-known/host-meta").then(function(t){return t.text()}).then(function(t){return function(t){var e=new kt,r=null,n=null;if(e.on("start",function(t){r=t}),e.on("element",function(t){r.append(t)}),e.on("error",function(t){n=t}),e.write(t),e.end(),n)throw n;return r}(t).getChildren("Link").filter(function(t){return["urn:xmpp:alt-connections:websocket","urn:xmpp:alt-connections:httppoll","urn:xmpp:alt-connections:xbosh"].includes(t.attrs.rel)}).map(function(t){t=t.attrs;return{rel:t.rel,href:t.href,method:t.rel.split(":").pop(),uri:t.href}}).sort(r)}).catch(function(){return[]})}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var Ie;function Fe(){}Ie=function(){return Promise.all([te.resolve?te.resolve.apply(te,arguments):Promise.resolve([]),Xe.resolve.apply(Xe,arguments)]).then(function(t){var e=t[0],t=t[1];return[].concat(e,t)})},te.resolve&&(Ie.dns=te),Ie.http=Xe;var ze=He(function(e,t){var r=!1;if(0===t.length)throw new Error("Couldn't connect");var n=t.shift(),o=e._findTransport(n);if(!o)return ze(e,t);e._status("connecting",n);var i,s=o.prototype.socketParameters(n),a=new o.prototype.Socket;return i=Ue(function(){return a.connect(s),De(We(a,"connect"))},function(){return r=!0,ze(e,t)}),n=function(t){return r?t:(e._attachSocket(a),a.emit("connect"),e.Transport=o,e.Socket=o.prototype.Socket,void(e.Parser=o.prototype.Parser))},i&&i.then?i.then(n):n(i)});function De(t,e){if(!e)return t&&t.then?t.then(Fe):Promise.resolve()}var Be=He(function(t){return $e(Ie(t,{srv:[{service:"xmpps-client",protocol:"tcp"},{service:"xmpp-client",protocol:"tcp"}]}),function(t){return[].concat(new Set(t.map(function(t){return t.uri})))})});function Ue(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}function $e(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var We=R.promise;function He(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}var Je=function(t){var n=t.entity,e=n.connect;n.connect=function(t){try{return!t||/:\/\//.test(t)?e.call(this,t):$e(Be(t),function(t){var e,r=(e=n,t.filter(function(t){return e._findTransport(t)}));if(0===r.length)throw new Error("No compatible transport found.");return Ue(function(){return De(ze(n,r))},function(t){throw n._reset(),n._status("disconnect"),t})})}catch(t){return Promise.reject(t)}}},Ke={};((Ke=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}).default=Ke).__esModule=!0;var Ye={};!function(e){!function(){"use strict";Ye.encode=function(t){return e.btoa(t)},Ye.decode=function(t){return e.atob(t)}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var Ge=u(c),Qe=function(o){function t(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(t=o.call.apply(o,[this].concat(r))||this).name="SASLError",t}return(0,Ge.default)(t,o),t}(_);function Ve(e,t){var r,n=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)),n}function Ze(){}_=function(t,e,r){(e.exports=r).Factory=r},"object"==typeof(tr={exports:{}}).exports&&_(tr.exports,tr,n({}));var tr=tr.exports,er=ir(function(t,o,e,r){var i=t.create([e]);if(!i)throw new Error("No compatible mechanism");var e=o.options.domain,s=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ve(Object(r),!0).forEach(function(t){Ke(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ve(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({username:null,password:null,server:e,host:e,realm:e,serviceType:"xmpp",serviceName:e},r);return new Promise(function(e,r){function n(t){t.attrs.xmlns===sr&&("challenge"!==t.name?("failure"===t.name?r(Qe.fromElement(t)):"success"===t.name&&e(),o.removeListener("nonza",n)):(i.challenge(or(t.text())),t=i.response(s),o.send(At("response",{xmlns:sr,mechanism:i.name},"string"==typeof t?nr(t):""))))}o.on("nonza",n),i.clientFirst&&o.send(At("auth",{xmlns:sr,mechanism:i.name},nr(i.response(s))))})});function rr(t,e){if(!e)return t&&t.then?t.then(Ze):Promise.resolve()}var nr=Ye.encode,or=Ye.decode;function ir(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}var sr="urn:ietf:params:xml:ns:xmpp-sasl";var ar=function(t,s){var t=t.streamFeatures,a=new tr;return t.use("mechanisms",sr,ir(function(t){var e,r=t.stanza,n=t.entity,o=r.getChild("mechanisms",sr).children.map(function(t){return t.text()}),i=a._mechs.map(function(t){return t.name}).filter(function(t){return o.includes(t)})[0];return e=function(){return rr(n.restart())},(t=(t=function(){return"function"==typeof s?rr(s(function(t){return er(a,n,i,t,r)},i)):(s.username||s.password||(i="ANONYMOUS"),rr(er(a,n,i,s,r)))})())&&t.then?t.then(e):e(t)})),{use:function(){return a.use.apply(a,arguments)}}};function ur(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var cr=lr(function(e,t,r){return ur(t.set(At("bind",{xmlns:fr},(r=r)&&At("resource",{},r))),function(t){t=t.getChildText("jid");return e._jid(t),t})});function lr(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}var fr="urn:ietf:params:xml:ns:xmpp-bind";var hr=function(t,e){var n,o,r=t.streamFeatures,t=t.iqCaller;r.use("bind",fr,(n=e,o={iqCaller:t}.iqCaller,lr(function(t,e){var r=t.entity;return ur("function"==typeof n?n(function(t){return cr(r,o,t)}):cr(r,o,n),function(){e()})})))};var pr="urn:ietf:params:xml:ns:xmpp-session",dr=function(t){var r,i=t.iqCaller;t.streamFeatures.use("session",pr,(r=function(t,e,r){return r.getChild("optional")?e():(n=i.set(At("session",pr)),r=function(){return e()},o?r?r(n):n:(n&&n.then||(n=Promise.resolve(n)),r?n.then(r):n));var n,o},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}))};function mr(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var vr=wr(function(t,e,r){return mr(t.sendReceive(At("resume",{xmlns:br,h:e,previd:r})),function(t){if(!t.is("resumed",br))throw t;return t})});function yr(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}var gr=wr(function(o,t,e){return o.send(At("enable",{xmlns:br,max:e,resume:t?"true":void 0})),new Promise(function(r,n){o.on("nonza",function t(e){if(e.is("enabled",br))r(e);else{if(!e.is("failed",br))return;n(e)}o.removeListener("nonza",t)})})});var br="urn:xmpp:sm:3";function wr(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}var _r=function(t){var e=t.streamFeatures,i=t.entity,t=t.middleware,s=null,a={allowResume:!0,preferredMaximum:null,enabled:!1,id:"",outbound:0,inbound:0,max:null};return i.on("online",function(t){s=t,a.outbound=0,a.inbound=0}),i.on("offline",function(){a.outbound=0,a.inbound=0,a.enabled=!1,a.id=""}),t.use(function(t,e){t=t.stanza;return["presence","message","iq"].includes(t.name)?a.inbound+=1:t.is("r",br)?i.send(At("a",{xmlns:br,h:a.inbound})).catch(function(){}):t.is("a",br)&&(a.outbound=t.attrs.h),e()}),e.use("sm",br,wr(function(t,e){var r,n,o=!1;return n=function(t){return o?t:function(t,e,r){if(r)return e?e(t()):t();try{var n=Promise.resolve(t());return e?n.then(e):n}catch(t){return Promise.reject(t)}}(e,function(){var t,e,r=gr(i,a.allowResume,a.preferredMaximum);return a.outbound=0,t=yr(function(){return mr(r,function(t){a.enabled=!0,a.id=t.attrs.id,a.max=t.attrs.max})},function(){a.enabled=!1}),e=function(){a.inbound=0},t&&t.then?t.then(e):e(t)})},(r=(r=function(){if(a.id)return yr(function(){return mr(vr(i,a.inbound,a.id),function(){return a.enabled=!0,i.jid=s,i.status="online",o=!0})},function(){a.id="",a.enabled=!1,a.outbound=0})})())&&r.then?r.then(n):n(r)})),a};n=function(t,e,r){(e.exports=r).Mechanism=r},"object"==typeof(xr={exports:{}}).exports&&n(xr.exports,xr,r({}));var xr=xr.exports,jr=function(t){t.use(xr)};r=function(t,e,r){(e.exports=r).Mechanism=r},"object"==typeof(Pr={exports:{}}).exports&&r(Pr.exports,Pr,e({}));var Pr=Pr.exports,Er=function(t){t.use(Pr)},r={},Or=u(o),Sr=["resource","credentials","username","password"],e=U.xml,o=U.jid,Lr=U.Client;return r.xml=e,r.jid=o,r.client=function(t){var e=t=void 0===t?{}:t,r=t.resource,n=t.credentials,o=t.username,i=t.password,s=(f=(0,Or.default)(t,Sr)).domain,a=f.service;!s&&a&&(f.domain=Kt(a));var u=new Lr(f),c=Zt({entity:u}),l=ue({entity:u}),t=ye({entity:u}),e=be({middleware:t}),s=Se({middleware:t,entity:u}),a=Ne({middleware:t,entity:u}),f=Je({entity:u}),h=ar({streamFeatures:e},n||{username:o,password:i}),n=_r({streamFeatures:e,entity:u,middleware:t}),o=hr({iqCaller:s,streamFeatures:e},r),i=dr({iqCaller:s,streamFeatures:e}),r=Object.entries({plain:Er,anonymous:jr}).map(function(t){var e=t[0],r=t[1],t={};return t[e]=r(h),t});return Object.assign(u,{entity:u,reconnect:c,websocket:l,middleware:t,streamFeatures:e,iqCaller:s,iqCallee:a,resolve:f,sasl:h,resourceBinding:o,sessionEstablishment:i,streamManagement:n,mechanisms:r})},r});
//# sourceMappingURL=xmpp.min.js.map