<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Memory Spiel Deluxe</title>
  <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #6dd5fa, #2980b9);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 20px;
      max-width: 420px;
      width: 95%;
      display: flex;
      flex-direction: column;
    }
    h2 {
      text-align: center;
      color: #2980b9;
      margin-bottom: 15px;
    }
    .inputs {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }
    .inputs input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    .inputs button {
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .inputs button:nth-child(3) { background: #3498db; color: white; }
    .inputs button:nth-child(4) { background: #2ecc71; color: white; }
    .inputs button:hover { opacity: 0.9; }
    #info, #score {
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
    }
    #game-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    .card {
      aspect-ratio: 1 / 1;
      perspective: 1000px;
      cursor: pointer;
      position: relative;
    }
    .card-inner {
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      position: relative;
    }
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      backface-visibility: hidden;
    }
    .card-front {
      background: #2980b9;
      color: white;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-back {
      transform: rotateY(180deg);
      background-size: cover;
      background-position: center;
    }
    /* Chat Box */
    #chat {
      border: 1px solid #ddd;
      border-radius: 8px;
      height: 120px;
      overflow-y: auto;
      margin-top: 10px;
      padding: 8px;
      background: #fafafa;
      font-size: 14px;
    }
    #chat-input {
      display: flex;
      margin-top: 5px;
    }
    #chat-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px 0 0 6px;
    }
    #chat-input button {
      padding: 8px 12px;
      border: none;
      background: #3498db;
      color: white;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
    }
    @media (max-width: 480px) {
      #game-board { gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Memory Spiel Deluxe</h2>
    <div class="inputs" id="buttons">
      <input type="text" id="roomId" placeholder="Raum-ID">
      <input type="text" id="playerName" placeholder="Dein Name">
      <button onclick="createRoom()">Raum erstellen</button>
      <button onclick="joinRoom()">Raum beitreten</button>
    </div>
    <div id="info"></div>
    <div id="score"></div>
    <div id="game-board"></div>
    <div id="chat"></div>
    <div id="chat-input">
      <input type="text" id="chatMessage" placeholder="Nachricht...">
      <button onclick="sendMessage()">Senden</button>
    </div>
  </div>

  <script>
    const socket = io();
    let playerId, currentRoomId = null;

    socket.on('connect', () => { playerId = socket.id; });

    function createRoom() {
      const roomId = document.getElementById('roomId').value.trim();
      const playerName = document.getElementById('playerName').value.trim();
      if (roomId && playerName) socket.emit('createRoom', { roomId, playerName });
    }

    function joinRoom() {
      const roomId = document.getElementById('roomId').value.trim();
      const playerName = document.getElementById('playerName').value.trim();
      if (roomId && playerName) socket.emit('joinRoom', { roomId, playerName });
    }

    function sendMessage() {
      const msg = document.getElementById('chatMessage').value.trim();
      if (msg && currentRoomId) {
        socket.emit('sendChatMessage', { roomId: currentRoomId, name: document.getElementById('playerName').value.trim(), message: msg });
        document.getElementById('chatMessage').value = '';
      }
    }

    document.getElementById('chatMessage').addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    socket.on('roomCreated', roomId => {
      currentRoomId = roomId;
      document.getElementById('info').innerText = `Raum erstellt: ${roomId}`;
    });

    socket.on('playerJoined', players => {
      document.getElementById('info').innerText = 'Spieler: ' + players.map(p => p.name).join(', ');
      if (!currentRoomId) currentRoomId = document.getElementById('roomId').value.trim();
    });

    socket.on('gameStart', ({ cards, currentTurn, players, roomId }) => {
      currentRoomId = roomId;
      document.getElementById('buttons').style.display = 'none'; // ðŸ”¥ Buttons ausblenden
      renderBoard(cards, currentTurn);
      updateScore(players);
    });

    socket.on('gameUpdate', ({ cards, currentTurn, players }) => {
      renderBoard(cards, currentTurn);
      updateScore(players);
    });

    socket.on('gameEnd', ({ winner, scores }) => {
      document.getElementById('info').innerText = `ðŸ† ${winner} hat gewonnen!`;
      updateScore(scores);
    });

    socket.on('flipError', msg => {
      document.getElementById('info').innerText = msg;
    });

    socket.on('chatHistory', msgs => {
      const chat = document.getElementById('chat');
      chat.innerHTML = '';
      msgs.forEach(m => appendChat(m));
    });

    socket.on('newChatMessage', m => appendChat(m));

    function appendChat({ name, message, time }) {
      const chat = document.getElementById('chat');
      chat.innerHTML += `<div><strong>${time} ${name}:</strong> ${message}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function renderBoard(cards, currentTurn) {
      const board = document.getElementById('game-board');
      board.innerHTML = '';
      cards.forEach(card => {
        const wrapper = document.createElement('div');
        wrapper.className = `card ${card.isFlipped || card.isMatched ? 'flipped' : ''}`;
        const inner = document.createElement('div');
        inner.className = 'card-inner';

        const front = document.createElement('div');
        front.className = 'card-front';
        front.textContent = '?';

        const back = document.createElement('div');
        back.className = 'card-back';
        back.style.backgroundImage = `url(${card.image})`;

        inner.appendChild(front);
        inner.appendChild(back);
        wrapper.appendChild(inner);

        if (currentTurn === playerId && !card.isFlipped && !card.isMatched) {
          wrapper.addEventListener('click', () => socket.emit('flipCard', { roomId: currentRoomId, cardId: card.id }));
        }

        board.appendChild(wrapper);
      });
    }

    function updateScore(players) {
      document.getElementById('score').innerText = players.map(p => `${p.name}: ${p.score}`).join(' | ');
    }
  </script>
</body>
</html>
