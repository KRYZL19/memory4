<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Memory Spiel Deluxe</title>
  <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #000;
      --primary: #2980b9;
    }
    [data-theme="dark"] {
      --bg: #1e1e1e;
      --text: #f4f4f4;
      --primary: #3498db;
    }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; height: 100vh; }
    .container { background: var(--bg); border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); padding: 20px; max-width: 420px; width: 95%; display: flex; flex-direction: column; }
    h2 { text-align: center; color: var(--primary); margin-bottom: 15px; }
    .hidden { display: none !important; }
    .inputs { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
    .inputs select, .inputs input, .inputs button { padding: 10px; font-size: 16px; border-radius: 8px; }
    .inputs button { border: none; cursor: pointer; }
    .btn-create { background: #3498db; color: white; }
    .btn-join { background: #2ecc71; color: white; }
    #info, #score, #timer { text-align: center; margin-top: 5px; font-weight: bold; }
    #game-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
    .card { aspect-ratio: 1/1; perspective: 1000px; cursor: pointer; position: relative; }
    .card-inner { width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .card-front, .card-back { position: absolute; width: 100%; height: 100%; border-radius: 10px; backface-visibility: hidden; }
    .card-front { background: var(--primary); color: white; font-size: 2rem; display: flex; align-items: center; justify-content: center; }
    .card-back { transform: rotateY(180deg); background-size: cover; background-position: center; }
    #chat { border: 1px solid #ddd; border-radius: 8px; height: 100px; overflow-y: auto; margin-top: 10px; padding: 8px; background: #fafafa; font-size: 14px; }
    #chat-input { display: flex; margin-top: 5px; }
    #chat-input input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px 0 0 6px; }
    #chat-input button { padding: 8px 12px; border: none; background: #3498db; color: white; border-radius: 0 6px 6px 0; cursor: pointer; }
    #emoji-bar { margin-top: 5px; text-align: center; }
    #emoji-bar button { font-size: 18px; margin: 2px; cursor: pointer; }
    #darkModeToggle { position: absolute; top: 10px; right: 10px; cursor: pointer; }
    #winner { text-align: center; font-size: 1.5rem; color: var(--primary); margin-top: 10px; }
    #newGameBtn { display:none; margin: 10px auto; padding:10px; font-size:16px; background:#2ecc71; color:white; border:none; border-radius:8px; cursor:pointer; }
    canvas#confetti { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }
    #lobby { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fafafa; }
    .room { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #eee; }
    .room button { background: #2ecc71; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body data-theme="light">
  <canvas id="confetti"></canvas>
  <div id="darkModeToggle">üåô</div>
  <div class="container">
    <h2>Memory Spiel Deluxe</h2>

    <!-- Lobby -->
    <div id="lobby-section">
      <div id="lobby"><p>Lade offene R√§ume...</p></div>
      <div class="inputs">
        <input type="text" id="playerNameLobby" placeholder="Dein Name">
        <input type="text" id="roomIdLobby" placeholder="Neue Raum-ID">
        <select id="turnTimeLobby">
          <option value="10">Zugzeit: 10s</option>
          <option value="15">Zugzeit: 15s</option>
          <option value="20">Zugzeit: 20s</option>
          <option value="30">Zugzeit: 30s</option>
        </select>
        <button class="btn-create" onclick="createRoom()">Neuen Raum erstellen</button>
      </div>
    </div>

    <!-- Game UI -->
    <div id="game-section" class="hidden">
      <div id="info"></div>
      <div id="timer"></div>
      <div id="score"></div>
      <div id="game-board"></div>
      <div id="winner"></div>
      <button id="newGameBtn" onclick="restartGame()">Neues Spiel starten</button>
      <div id="chat"></div>
      <div id="chat-input">
        <input type="text" id="chatMessage" placeholder="Nachricht...">
        <button onclick="sendMessage()">Senden</button>
      </div>
      <div id="emoji-bar">
        <button onclick="sendEmoji('üòÇ')">üòÇ</button>
        <button onclick="sendEmoji('üëè')">üëè</button>
        <button onclick="sendEmoji('üî•')">üî•</button>
        <button onclick="sendEmoji('üëç')">üëç</button>
        <button onclick="sendEmoji('üéâ')">üéâ</button>
        <button onclick="sendEmoji('üòç')">üòç</button>
        <button onclick="sendEmoji('ü§Ø')">ü§Ø</button>
        <button onclick="sendEmoji('üôå')">üôå</button>
        <button onclick="sendEmoji('ü•≥')">ü•≥</button>
        <button onclick="sendEmoji('üíØ')">üíØ</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let playerId, currentRoomId = null, playerName = "";

    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
    let confettiParticles = [];

    socket.on('connect', () => { playerId = socket.id; socket.emit('getRooms'); });

    // üåê Lobby-Updates
    socket.on('roomList', (rooms) => {
      const lobbyDiv = document.getElementById('lobby');
      lobbyDiv.innerHTML = rooms.length === 0 ? "<p>Keine offenen R√§ume.</p>" : "";
      rooms.forEach(room => {
        const div = document.createElement('div');
        div.className = 'room';
        div.innerHTML = `<span><strong>${room.roomId}</strong> (${room.players.join(', ') || 'Wartend'}) - ${room.turnTime}s</span>
                         <button onclick="joinRoom('${room.roomId}')">Beitreten</button>`;
        lobbyDiv.appendChild(div);
      });
    });

    function createRoom() {
      playerName = document.getElementById('playerNameLobby').value.trim();
      const roomId = document.getElementById('roomIdLobby').value.trim();
      const turnTime = document.getElementById('turnTimeLobby').value;
      if (playerName && roomId) {
        socket.emit('createRoom', { roomId, playerName, turnTime });
      }
    }

    function joinRoom(roomId) {
      playerName = document.getElementById('playerNameLobby').value.trim() || prompt("Bitte gib deinen Namen ein:");
      if (playerName) socket.emit('joinRoom', { roomId, playerName });
    }

    // üéÆ Game Events
    socket.on('roomCreated', (roomId) => { enterGame(roomId); });
    socket.on('playerJoined', players => { document.getElementById('info').innerText = 'Spieler: ' + players.map(p => p.name).join(', '); });
    socket.on('gameStart', ({ cards, currentTurn, players, roomId }) => {
      enterGame(roomId);
      renderBoard(cards, currentTurn);
      updateScore(players);
    });
    socket.on('timerUpdate', (t) => document.getElementById('timer').innerText = `‚è± Zugzeit: ${t}s`);
    socket.on('gameUpdate', ({ cards, currentTurn, players }) => { renderBoard(cards, currentTurn); updateScore(players); });
    socket.on('gameEnd', ({ winner, scores }) => {
      document.getElementById('winner').innerHTML = `üèÜ ${winner} hat gewonnen!`;
      launchConfetti();
      document.getElementById('newGameBtn').style.display = 'block';
    });

    function enterGame(roomId) {
      currentRoomId = roomId;
      document.getElementById('lobby-section').classList.add('hidden');
      document.getElementById('game-section').classList.remove('hidden');
    }

    function restartGame() { socket.emit('restartGame', currentRoomId); document.getElementById('winner').innerHTML = ''; document.getElementById('newGameBtn').style.display = 'none'; }

    function renderBoard(cards, currentTurn) {
      const board = document.getElementById('game-board');
      board.innerHTML = '';
      cards.forEach(card => {
        const wrapper = document.createElement('div');
        wrapper.className = `card ${card.isFlipped || card.isMatched ? 'flipped' : ''}`;
        const inner = document.createElement('div');
        inner.className = 'card-inner';
        const front = document.createElement('div');
        front.className = 'card-front';
        front.textContent = '?';
        const back = document.createElement('div');
        back.className = 'card-back';
        back.style.backgroundImage = `url(${card.image})`;
        inner.appendChild(front);
        inner.appendChild(back);
        wrapper.appendChild(inner);
        if (currentTurn === playerId && !card.isFlipped && !card.isMatched) {
          wrapper.addEventListener('click', () => socket.emit('flipCard', { roomId: currentRoomId, cardId: card.id }));
        }
        board.appendChild(wrapper);
      });
    }

    function updateScore(players) { document.getElementById('score').innerText = players.map(p => `${p.name}: ${p.score}`).join(' | '); }

    // üéâ Confetti
    function launchConfetti() {
      confettiParticles = Array.from({ length: 150 }, () => ({
        x: Math.random() * confettiCanvas.width,
        y: Math.random() * confettiCanvas.height - confettiCanvas.height,
        r: Math.random() * 6 + 4,
        d: Math.random() * 0.5 + 0.5,
        color: `hsl(${Math.random()*360},100%,50%)`
      }));
      requestAnimationFrame(drawConfetti);
    }
    function drawConfetti() {
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      confettiParticles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fillStyle = p.color;
        ctx.fill();
        p.y += p.d * 4;
        if (p.y > confettiCanvas.height) p.y = -10;
      });
      requestAnimationFrame(drawConfetti);
    }

    // Chat & Emojis
    function sendMessage() {
      const msg = document.getElementById('chatMessage').value.trim();
      if (msg && currentRoomId) {
        socket.emit('sendChatMessage', { roomId: currentRoomId, name: playerName, message: msg });
        document.getElementById('chatMessage').value = '';
      }
    }
    function sendEmoji(emoji) { sendMessageDirect(emoji); }
    function sendMessageDirect(msg) {
      if (msg && currentRoomId) socket.emit('sendChatMessage', { roomId: currentRoomId, name: playerName, message: msg });
    }
    socket.on('chatHistory', msgs => { const chat = document.getElementById('chat'); chat.innerHTML = ''; msgs.forEach(m => appendChat(m)); });
    socket.on('newChatMessage', m => appendChat(m));
    function appendChat({ name, message, time }) {
      const chat = document.getElementById('chat');
      chat.innerHTML += `<div><strong>${time} ${name}:</strong> ${message}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    // Dark Mode
    document.getElementById('darkModeToggle').addEventListener('click', () => {
      const body = document.body;
      const current = body.getAttribute('data-theme');
      const newTheme = current === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', newTheme);
      document.getElementById('darkModeToggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', newTheme);
    });
    window.addEventListener('load', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      document.getElementById('darkModeToggle').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    });
  </script>
</body>
</html>
