<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Memory Spiel Deluxe</title>
  <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #000;
      --primary: #2980b9;
    }
    [data-theme="dark"] {
      --bg: #1e1e1e;
      --text: #f4f4f4;
      --primary: #3498db;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: var(--bg);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 20px;
      max-width: 420px;
      width: 95%;
      display: flex;
      flex-direction: column;
    }
    h2 { text-align: center; color: var(--primary); margin-bottom: 15px; }
    .inputs { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
    .inputs input, .inputs button { padding: 10px; font-size: 16px; border-radius: 8px; }
    .inputs button { border: none; cursor: pointer; }
    .btn-create { background: #3498db; color: white; }
    .btn-join { background: #2ecc71; color: white; }
    #info, #score, #timer { text-align: center; margin-top: 5px; font-weight: bold; }
    #game-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
    .card { aspect-ratio: 1/1; perspective: 1000px; cursor: pointer; position: relative; }
    .card-inner { width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .card-front, .card-back { position: absolute; width: 100%; height: 100%; border-radius: 10px; backface-visibility: hidden; }
    .card-front { background: var(--primary); color: white; font-size: 2rem; display: flex; align-items: center; justify-content: center; }
    .card-back { transform: rotateY(180deg); background-size: cover; background-position: center; }
    #chat { border: 1px solid #ddd; border-radius: 8px; height: 100px; overflow-y: auto; margin-top: 10px; padding: 8px; background: #fafafa; font-size: 14px; }
    #chat-input { display: flex; margin-top: 5px; }
    #chat-input input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px 0 0 6px; }
    #chat-input button { padding: 8px 12px; border: none; background: #3498db; color: white; border-radius: 0 6px 6px 0; cursor: pointer; }
    #emoji-bar { margin-top: 5px; text-align: center; }
    #emoji-bar button { font-size: 18px; margin: 2px; cursor: pointer; }
    #darkModeToggle { position: absolute; top: 10px; right: 10px; cursor: pointer; }
    #winner { text-align: center; font-size: 1.5rem; color: var(--primary); margin-top: 10px; }
    canvas#confetti { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }
    @media (max-width: 480px) { #game-board { gap: 8px; } }
  </style>
</head>
<body data-theme="light">
  <canvas id="confetti"></canvas>
  <div id="darkModeToggle">üåô</div>
  <div class="container">
    <h2>Memory Spiel Deluxe</h2>
    <div class="inputs" id="buttons">
      <input type="text" id="roomId" placeholder="Raum-ID">
      <input type="text" id="playerName" placeholder="Dein Name">
      <button class="btn-create" onclick="createRoom()">Raum erstellen</button>
      <button class="btn-join" onclick="joinRoom()">Raum beitreten</button>
    </div>
    <div id="info"></div>
    <div id="timer"></div>
    <div id="score"></div>
    <div id="game-board"></div>
    <div id="winner"></div>
    <div id="chat"></div>
    <div id="chat-input">
      <input type="text" id="chatMessage" placeholder="Nachricht...">
      <button onclick="sendMessage()">Senden</button>
    </div>
    <div id="emoji-bar">
      <button onclick="sendEmoji('üòÇ')">üòÇ</button>
      <button onclick="sendEmoji('üëè')">üëè</button>
      <button onclick="sendEmoji('üî•')">üî•</button>
      <button onclick="sendEmoji('üëç')">üëç</button>
    </div>
  </div>
  <script>
    const socket = io();
    let playerId, currentRoomId = null;

    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
    let confettiParticles = [];

    socket.on('connect', () => { playerId = socket.id; });

    function createRoom() {
      const roomId = document.getElementById('roomId').value.trim();
      const playerName = document.getElementById('playerName').value.trim();
      if (roomId && playerName) socket.emit('createRoom', { roomId, playerName });
    }

    function joinRoom() {
      const roomId = document.getElementById('roomId').value.trim();
      const playerName = document.getElementById('playerName').value.trim();
      if (roomId && playerName) socket.emit('joinRoom', { roomId, playerName });
    }

    function sendMessage() {
      const msg = document.getElementById('chatMessage').value.trim();
      if (msg && currentRoomId) {
        socket.emit('sendChatMessage', { roomId: currentRoomId, name: document.getElementById('playerName').value.trim(), message: msg });
        document.getElementById('chatMessage').value = '';
      }
    }

    function sendEmoji(emoji) {
      socket.emit('sendChatMessage', { roomId: currentRoomId, name: document.getElementById('playerName').value.trim(), message: emoji });
    }

    document.getElementById('chatMessage').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    document.getElementById('darkModeToggle').addEventListener('click', () => {
      const body = document.body;
      const current = body.getAttribute('data-theme');
      const newTheme = current === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', newTheme);
      document.getElementById('darkModeToggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', newTheme);
    });

    window.addEventListener('load', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      document.getElementById('darkModeToggle').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    });

    socket.on('roomCreated', roomId => { currentRoomId = roomId; document.getElementById('info').innerText = `Raum erstellt: ${roomId}`; });
    socket.on('playerJoined', players => { document.getElementById('info').innerText = 'Spieler: ' + players.map(p => p.name).join(', '); if (!currentRoomId) currentRoomId = document.getElementById('roomId').value.trim(); });
    socket.on('gameStart', ({ cards, currentTurn, players, roomId }) => { currentRoomId = roomId; document.getElementById('buttons').style.display = 'none'; renderBoard(cards, currentTurn); updateScore(players); });
    socket.on('timerUpdate', (t) => document.getElementById('timer').innerText = `‚è± Zugzeit: ${t}s`);
    socket.on('gameUpdate', ({ cards, currentTurn, players }) => { renderBoard(cards, currentTurn); updateScore(players); });
    socket.on('gameEnd', ({ winner, scores, stats, duration }) => {
      document.getElementById('winner').innerHTML = `üèÜ ${winner} hat gewonnen!<br><small>Dauer: ${duration}s</small>`;
      showStats(stats);
      launchConfetti();
    });
    socket.on('flipError', msg => document.getElementById('info').innerText = msg);
    socket.on('chatHistory', msgs => { const chat = document.getElementById('chat'); chat.innerHTML = ''; msgs.forEach(m => appendChat(m)); });
    socket.on('newChatMessage', m => appendChat(m));

    function appendChat({ name, message, time }) {
      const chat = document.getElementById('chat');
      chat.innerHTML += `<div><strong>${time} ${name}:</strong> ${message}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function renderBoard(cards, currentTurn) {
      const board = document.getElementById('game-board');
      board.innerHTML = '';
      cards.forEach(card => {
        const wrapper = document.createElement('div');
        wrapper.className = `card ${card.isFlipped || card.isMatched ? 'flipped' : ''}`;
        const inner = document.createElement('div');
        inner.className = 'card-inner';

        const front = document.createElement('div');
        front.className = 'card-front';
        front.textContent = '?';

        const back = document.createElement('div');
        back.className = 'card-back';
        back.style.backgroundImage = `url(${card.image})`;

        inner.appendChild(front);
        inner.appendChild(back);
        wrapper.appendChild(inner);

        if (currentTurn === playerId && !card.isFlipped && !card.isMatched) {
          wrapper.addEventListener('click', () => socket.emit('flipCard', { roomId: currentRoomId, cardId: card.id }));
        }
        board.appendChild(wrapper);
      });
    }

    function updateScore(players) {
      document.getElementById('score').innerText = players.map(p => `${p.name}: ${p.score}`).join(' | ');
    }

    function showStats(stats) {
      const statLines = stats.map(s => `${s.name}: ${s.moves} Z√ºge | ${s.hits} Treffer | Genauigkeit: ${s.accuracy}`).join('\n');
      const div = document.createElement('div');
      div.style.textAlign = 'center';
      div.style.marginTop = '10px';
      div.innerHTML = `<pre>${statLines}</pre>`;
      document.querySelector('.container').appendChild(div);
    }

    // üéâ Konfetti-Animation
    function launchConfetti() {
      confettiParticles = Array.from({ length: 150 }, () => ({
        x: Math.random() * confettiCanvas.width,
        y: Math.random() * confettiCanvas.height - confettiCanvas.height,
        r: Math.random() * 6 + 4,
        d: Math.random() * 0.5 + 0.5,
        color: `hsl(${Math.random()*360},100%,50%)`
      }));
      requestAnimationFrame(drawConfetti);
    }

    function drawConfetti() {
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      confettiParticles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fillStyle = p.color;
        ctx.fill();
        p.y += p.d * 4;
        if (p.y > confettiCanvas.height) p.y = -10;
      });
      requestAnimationFrame(drawConfetti);
    }
  </script>
</body>
</html>
